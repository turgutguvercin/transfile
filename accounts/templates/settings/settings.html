{% extends 'base.html' %}

{% block title %}Change Password - Transfile{% endblock %}

{% block page_header %}
<div class="page-header">
    <div class="container text-center">
        <h1 class="fade-in">
            <i class="bi bi-shield-lock me-3"></i>Change Password
        </h1>
        <p class="slide-up">Update your account security with a new password</p>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-6">
        <div class="card-modern fade-in">
            <div class="card-body p-4">
                <!-- Django Form Errors -->
                {% if form.errors %}
                    <div class="alert alert-danger mb-4">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        <strong>Please correct the following errors:</strong>
                        <ul class="mt-2 mb-0">
                            {% for field in form %}
                                {% for error in field.errors %}
                                    <li>{{ field.label }}: {{ error }}</li>
                                {% endfor %}
                            {% endfor %}
                            {% for error in form.non_field_errors %}
                                <li>{{ error }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                {% endif %}

                <!-- Security Info -->
                <div class="alert alert-info alert-modern mb-4">
                    <i class="bi bi-shield-check me-2"></i>
                    <strong>Security First!</strong> Choose a strong password with at least 8 characters, including uppercase, lowercase, numbers, and special characters.
                </div>

                <form method="POST" class="needs-validation" novalidate>
                    {% csrf_token %}
                    
                    <!-- Current Password -->
                    <div class="mb-4">
                        <label for="old_password" class="form-label fw-semibold">
                            <i class="bi bi-key me-2"></i>Current Password
                        </label>
                        <div class="input-group">
                            <input type="password" class="form-control {% if form.old_password.errors %}is-invalid{% endif %}" 
                                   id="old_password" name="old_password" 
                                   placeholder="Enter your current password" required
                                   value="{{ form.old_password.value|default:'' }}">
                            <button class="btn btn-outline-secondary" type="button" id="toggleOldPassword">
                                <i class="bi bi-eye"></i>
                            </button>
                        </div>
                        {% if form.old_password.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.old_password.errors %}{{ error }}{% endfor %}
                            </div>
                        {% else %}
                            <div class="invalid-feedback">
                                Please enter your current password.
                            </div>
                        {% endif %}
                    </div>

                    <!-- New Password -->
                    <div class="mb-4">
                        <label for="new_password1" class="form-label fw-semibold">
                            <i class="bi bi-shield-plus me-2"></i>New Password
                        </label>
                        <div class="input-group">
                            <input type="password" class="form-control {% if form.new_password1.errors %}is-invalid{% endif %}" 
                                   id="new_password1" name="new_password1" 
                                   placeholder="Enter your new password" required minlength="8"
                                   value="{{ form.new_password1.value|default:'' }}">
                            <button class="btn btn-outline-secondary" type="button" id="toggleNewPassword1">
                                <i class="bi bi-eye"></i>
                            </button>
                        </div>
                        {% if form.new_password1.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.new_password1.errors %}{{ error }}{% endfor %}
                            </div>
                        {% else %}
                            <div class="invalid-feedback">
                                Password must be at least 8 characters long.
                            </div>
                        {% endif %}
                        <!-- Password Strength Indicator -->
                        <div class="mt-2">
                            <div class="password-strength-bar">
                                <div class="strength-meter" id="strengthMeter"></div>
                            </div>
                            <small class="text-muted" id="strengthText">Password strength: Weak</small>
                        </div>
                    </div>

                    <!-- Confirm New Password -->
                    <div class="mb-4">
                        <label for="new_password2" class="form-label fw-semibold">
                            <i class="bi bi-shield-check me-2"></i>Confirm New Password
                        </label>
                        <div class="input-group">
                            <input type="password" class="form-control {% if form.new_password2.errors %}is-invalid{% endif %}" 
                                   id="new_password2" name="new_password2" 
                                   placeholder="Confirm your new password" required minlength="8"
                                   value="{{ form.new_password2.value|default:'' }}">
                            <button class="btn btn-outline-secondary" type="button" id="toggleNewPassword2">
                                <i class="bi bi-eye"></i>
                            </button>
                        </div>
                        {% if form.new_password2.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.new_password2.errors %}{{ error }}{% endfor %}
                            </div>
                        {% else %}
                            <div class="invalid-feedback" id="confirmPasswordFeedback">
                                Passwords must match.
                            </div>
                        {% endif %}
                    </div>

                    <!-- Password Requirements -->
                    <div class="card mb-4" style="background: rgba(79, 70, 229, 0.05); border: 1px solid rgba(79, 70, 229, 0.1);">
                        <div class="card-body p-3">
                            <h6 class="text-primary mb-2">
                                <i class="bi bi-list-check me-2"></i>Password Requirements
                            </h6>
                            <ul class="list-unstyled mb-0 small">
                                <li id="req-length" class="requirement">
                                    <i class="bi bi-x-circle text-danger me-2"></i>At least 8 characters
                                </li>
                                <li id="req-uppercase" class="requirement">
                                    <i class="bi bi-x-circle text-danger me-2"></i>One uppercase letter
                                </li>
                                <li id="req-lowercase" class="requirement">
                                    <i class="bi bi-x-circle text-danger me-2"></i>One lowercase letter
                                </li>
                                <li id="req-number" class="requirement">
                                    <i class="bi bi-x-circle text-danger me-2"></i>One number
                                </li>
                                <li id="req-special" class="requirement">
                                    <i class="bi bi-x-circle text-danger me-2"></i>One special character
                                </li>
                            </ul>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="d-flex justify-content-between align-items-center">
                        <a href="{% url 'home' %}" class="btn btn-outline-secondary">
                            <i class="bi bi-arrow-left me-2"></i>Cancel
                        </a>
                        <button type="submit" class="btn btn-primary" id="submitBtn">
                            <i class="bi bi-shield-check me-2"></i>Update Password
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Security Tips -->
        <div class="card-modern mt-4 fade-in" style="animation-delay: 0.3s;">
            <div class="card-body m-3">
                <h6 class="text-primary mb-3">
                    <i class="bi bi-lightbulb me-2"></i>Security Tips
                </h6>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <div class="d-flex align-items-start">
                            <div class="flex-shrink-0 me-3">
                                <i class="bi bi-shield-fill-exclamation text-warning"></i>
                            </div>
                            <div>
                                <small class="fw-semibold">Unique Password</small>
                                <div class="text-muted small">Don't reuse passwords from other accounts</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <div class="d-flex align-items-start">
                            <div class="flex-shrink-0 me-3">
                                <i class="bi bi-clock-history text-info"></i>
                            </div>
                            <div>
                                <small class="fw-semibold">Regular Updates</small>
                                <div class="text-muted small">Change your password every 3-6 months</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <div class="d-flex align-items-start">
                            <div class="flex-shrink-0 me-3">
                                <i class="bi bi-key text-primary"></i>
                            </div>
                            <div>
                                <small class="fw-semibold">Password Manager</small>
                                <div class="text-muted small">Consider using a password manager for security</div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<style>
.password-strength-bar {
    width: 100%;
    height: 6px;
    background: #e5e7eb;
    border-radius: 3px;
    overflow: hidden;
}

.strength-meter {
    height: 100%;
    transition: all 0.3s ease;
    border-radius: 3px;
}

.requirement.met i {
    color: var(--success-color) !important;
}

.requirement.met i:before {
    content: "\f26b"; /* check-circle */
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Password visibility toggles
    const toggleButtons = {
        'toggleOldPassword': 'old_password',
        'toggleNewPassword1': 'new_password1',
        'toggleNewPassword2': 'new_password2'
    };

    Object.entries(toggleButtons).forEach(([buttonId, inputId]) => {
        const button = document.getElementById(buttonId);
        const input = document.getElementById(inputId);
        
        if (button && input) {
            button.addEventListener('click', function() {
                const type = input.getAttribute('type') === 'password' ? 'text' : 'password';
                input.setAttribute('type', type);
                
                const icon = button.querySelector('i');
                icon.className = type === 'password' ? 'bi bi-eye' : 'bi bi-eye-slash';
            });
        }
    });

    // Password strength checker
    const newPassword1 = document.getElementById('new_password1');
    const strengthMeter = document.getElementById('strengthMeter');
    const strengthText = document.getElementById('strengthText');
    
    const requirements = {
        'req-length': /^.{8,}$/,
        'req-uppercase': /[A-Z]/,
        'req-lowercase': /[a-z]/,
        'req-number': /[0-9]/,
        'req-special': /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\?]/
    };

    function checkPasswordStrength(password) {
        let score = 0;
        let metRequirements = 0;

        Object.entries(requirements).forEach(([reqId, regex]) => {
            const element = document.getElementById(reqId);
            if (element) {
                if (regex.test(password)) {
                    element.classList.add('met');
                    score += 20;
                    metRequirements++;
                } else {
                    element.classList.remove('met');
                }
            }
        });

        // Update strength meter
        let strengthClass = '';
        let strengthLabel = '';

        if (score === 0) {
            strengthClass = '';
            strengthLabel = 'Password strength: None';
        } else if (score <= 40) {
            strengthClass = 'bg-danger';
            strengthLabel = 'Password strength: Weak';
        } else if (score <= 60) {
            strengthClass = 'bg-warning';
            strengthLabel = 'Password strength: Fair';
        } else if (score <= 80) {
            strengthClass = 'bg-info';
            strengthLabel = 'Password strength: Good';
        } else {
            strengthClass = 'bg-success';
            strengthLabel = 'Password strength: Strong';
        }

        if (strengthMeter) {
            strengthMeter.className = `strength-meter ${strengthClass}`;
            strengthMeter.style.width = `${score}%`;
        }
        if (strengthText) {
            strengthText.textContent = strengthLabel;
        }

        return metRequirements >= 4; // At least 4 out of 5 requirements
    }

    if (newPassword1) {
        newPassword1.addEventListener('input', function() {
            checkPasswordStrength(this.value);
            checkPasswordMatch();
        });
    }

    // Password confirmation checker
    const newPassword2 = document.getElementById('new_password2');
    const confirmFeedback = document.getElementById('confirmPasswordFeedback');

    function checkPasswordMatch() {
        if (newPassword1 && newPassword2) {
            const password1 = newPassword1.value;
            const password2 = newPassword2.value;

            if (password2 && password1 !== password2) {
                newPassword2.setCustomValidity('Passwords do not match');
                if (confirmFeedback) {
                    confirmFeedback.textContent = 'Passwords do not match.';
                }
                newPassword2.classList.add('is-invalid');
            } else {
                newPassword2.setCustomValidity('');
                if (confirmFeedback) {
                    confirmFeedback.textContent = 'Passwords must match.';
                }
                newPassword2.classList.remove('is-invalid');
            }
        }
    }

    if (newPassword2) {
        newPassword2.addEventListener('input', checkPasswordMatch);
    }

    // Form submission with loading state
    const form = document.querySelector('form');
    const submitBtn = document.getElementById('submitBtn');

    if (form && submitBtn) {
        form.addEventListener('submit', function(event) {
            // Add loading state
            const originalText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Updating Password...';
            
            // Let the form submit naturally to Django
            // Don't prevent default - let Django handle the submission
        });
    }

    // Initialize password strength on page load if there's a value
    if (newPassword1 && newPassword1.value) {
        checkPasswordStrength(newPassword1.value);
        checkPasswordMatch();
    }
});
</script>
{% endblock %}
